# Исправление BUG-002: Аномалии на формирующейся свече

## Описание проблемы

**Приоритет:** High

**Симптомы:**
- Частые блокировки торговли с сообщением "Data anomaly detected" 
- Ложные срабатывания даже на нормальном рынке
- Проблема возникает особенно часто на doji-свечах (свечи с малым телом)

**Корневая причина:**
Детектор аномалий проверял **текущую формирующуюся свечу** (df.iloc[-1]), у которой может быть очень малое тело (open ≈ close) и нормальные тени. Из-за условия `wick > 3 * body` даже обычные движения цены помечались как аномалия.

## Реализованное решение

### Изменения в коде

**Файл:** `strategy/meta_layer.py`

**Изменение:** NoTradeZones.is_trading_allowed() теперь проверяет **последнюю закрытую свечу** (df.iloc[-2]) вместо текущей формирующейся (df.iloc[-1]).

```python
# До исправления:
latest = df.iloc[-1]  # Текущая формирующаяся свеча
has_anomaly = latest.get("has_anomaly", 0)

# После исправления:
if len(df) < 2:
    candle_for_quality_check = df.iloc[-1]  # Fallback
else:
    candle_for_quality_check = df.iloc[-2]  # Последняя закрытая
    
has_anomaly = candle_for_quality_check.get("has_anomaly", 0)
```

### Логика работы

1. **Для проверок качества данных (аномалий):** используется последняя **закрытая** свеча
2. **Для других проверок (волатильность):** используется текущая свеча
3. **Защита от краевых случаев:** если в DataFrame < 2 свечей, используется единственная доступная

### Сохраненные возможности

- ✅ Детали аномалий логируются корректно (anomaly_wick, anomaly_low_volume, anomaly_gap)
- ✅ Реальные аномалии на закрытых свечах детектируются как и прежде
- ✅ Защита от doji-свечей (body_safe = max(body, 0.1% от цены)) продолжает работать

## Результаты

### Тестирование

- **15/15 тестов** проходят успешно
- **Новые тесты:**
  - `test_no_trade_zones_uses_closed_candle` - проверяет использование закрытой свечи
  - `test_no_trade_zones_ignores_current_forming_candle_anomaly` - проверяет игнорирование формирующейся
  - `test_no_trade_zones_single_candle_fallback` - проверяет fallback для одной свечи

### Демонстрация

Файл: `demo_bug002_fix.py`

```bash
python demo_bug002_fix.py
```

Показывает:
- ❌ СТАРОЕ ПОВЕДЕНИЕ: блокирует торговлю на doji с тенями
- ✅ НОВОЕ ПОВЕДЕНИЕ: разрешает торговлю, т.к. закрытая свеча нормальная
- ✅ Реальные аномалии на закрытых свечах детектируются корректно

### Code Review & Security

- ✅ Code review: без замечаний
- ✅ CodeQL security check: 0 уязвимостей

## Критерии приёмки

- [x] На обычном рынке блокировка "Data anomaly detected" становится редкой и объяснимой
- [x] В rejected-лог добавлена детализация: какая именно аномалия сработала

## Влияние на систему

**Минимальное:**
- Изменения только в логике проверки аномалий
- Все остальные проверки (spread, volatility, etc.) работают как прежде
- Обратная совместимость сохранена

**Положительный эффект:**
- Меньше ложных блокировок торговли
- Более точная детекция реальных проблем с данными
- Улучшенное логирование с деталями аномалий

## Примечания для разработчиков

При работе с NoTradeZones помните:
- Для **качества данных** (аномалии) → используется `iloc[-2]` (закрытая свеча)
- Для **текущего состояния** (волатильность) → используется `iloc[-1]` (текущая свеча)
- При модификации детектора аномалий учитывайте что проверяется закрытая, а не формирующаяся свеча

---

**Дата исправления:** 2026-02-08  
**Автор:** GitHub Copilot Agent  
**Тестирование:** Полное (15/15 тестов)  
**Статус:** ✅ Завершено и проверено
