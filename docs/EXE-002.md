# EXE-002: Position State Manager - Управление состоянием позиции

## Описание

**PositionStateManager** управляет состоянием открытой позиции с поддержкой:
- Partial fills (заполнение ордеров по частям)
- Корректная история средней цены входа
- Отслеживание ордеров (открытые, заполненные)
- Reconciliation с данными биржи
- Защита от "переворота" позиции
- Enforce reduceOnly для закрытий

## Класс PositionStateManager

### Основные методы

#### `open_position(side: str, qty: Decimal, entry_price: Decimal, order_id: str)`
Открыть новую позицию.

```python
manager = PositionStateManager("BTCUSDT")
manager.open_position("Long", Decimal("1.0"), Decimal("50000"), "order_1")
```

#### `add_partial_fill(order_id: str, fill_qty: Decimal, fill_price: Decimal, side: str) -> Tuple[bool, str]`
Обработать partial fill.

- Если side совпадает с текущей позицией - добавляет к позиции
- Если side противоположный - закрывает (редукция) без переворота
- Обновляет среднюю цену по формуле: `avg = total_cost / total_qty`

```python
# Добавляем к Long позиции
success, msg = manager.add_partial_fill(
    order_id="order_2",
    fill_qty=Decimal("0.5"),
    fill_price=Decimal("51000"),
    side="Long"
)

# Закрываем часть Long позиции (редукция)
success, msg = manager.add_partial_fill(
    order_id="order_2",
    fill_qty=Decimal("0.5"),
    fill_price=Decimal("51000"),
    side="Short"
)
```

#### `close_position(close_qty: Decimal, close_price: Decimal, order_id: str) -> Tuple[bool, str]`
Закрыть позицию (или часть) с флагом reduceOnly.

```python
success, msg = manager.close_position(
    close_qty=Decimal("1.0"),
    close_price=Decimal("51000"),
    order_id="order_3"
)
```

#### `reconcile_with_exchange(exchange_qty: Decimal, exchange_avg_price: Decimal) -> Tuple[bool, str]`
Синхронизировать локальное состояние с данными биржи.

```python
success, msg = manager.reconcile_with_exchange(
    exchange_qty=Decimal("1.0"),
    exchange_avg_price=Decimal("50100")
)
```

#### `get_position_info() -> Dict`
Получить информацию о позиции.

```python
info = manager.get_position_info()
# {
#   "symbol": "BTCUSDT",
#   "side": "Long",
#   "qty": Decimal("1.0"),
#   "avg_entry_price": Decimal("50000"),
#   "is_open": True
# }
```

#### `get_orders() -> List[Dict]`
Получить историю ордеров.

## Гарантии

### 1. Защита от переворота позиции
Позиция никогда не переворачивается при partial fill:

```python
# Long 1.0 @ 50000
manager.open_position("Long", Decimal("1.0"), Decimal("50000"), "order_1")

# Partial fill Short 0.5 @ 51000 просто уменьшает позицию
manager.add_partial_fill("order_2", Decimal("0.5"), Decimal("51000"), "Short")

assert manager.position.qty == Decimal("0.5")  # ✓ Уменьшилась
assert manager.position.side == "Long"         # ✓ Осталась Long
```

### 2. Корректная средняя цена при partial fills
Средняя цена обновляется корректно:

```python
# 0.5 BTC @ 50000 = $25000
manager.open_position("Long", Decimal("0.5"), Decimal("50000"), "order_1")

# +0.3 BTC @ 51000 = +$15300
manager.add_partial_fill("order_2", Decimal("0.3"), Decimal("51000"), "Long")

# avg = (25000 + 15300) / 0.8 = $50375
assert manager.position.avg_entry_price == Decimal("50375")
```

### 3. reduceOnly для закрытий
Все ордера закрытия помечаются флагом `reduce_only=True`:

```python
manager.close_position(Decimal("0.5"), Decimal("51000"), "order_2")

orders = manager.get_orders()
close_order = [o for o in orders if o["order_id"] == "order_2"][0]
assert close_order["reduce_only"] is True
```

### 4. Reconciliation с биржей
Локальное состояние синхронизируется с биржей:

```python
manager.open_position("Long", Decimal("1.0"), Decimal("50000"), "order_1")

# Биржа говорит что-то другое
manager.reconcile_with_exchange(
    exchange_qty=Decimal("0.95"),
    exchange_avg_price=Decimal("50050")
)

assert manager.position.qty == Decimal("0.95")
assert manager.position.avg_entry_price == Decimal("50050")
```

## Структуры данных

### Position
```python
@dataclass
class Position:
    symbol: str
    side: str  # "Long", "Short", None
    qty: Decimal  # текущий объём позиции
    avg_entry_price: Decimal  # средняя цена входа
    
    total_qty_opened: Decimal  # всего куплено/продано
    total_cost: Decimal  # всего потрачено (qty * price)
    
    open_orders: List[Order]
    filled_orders: List[Order]
    
    opened_at: Optional[datetime]
    updated_at: datetime
```

### Order
```python
@dataclass
class Order:
    order_id: str
    symbol: str
    side: str  # "Long", "Short", "Buy", "Sell"
    qty: Decimal
    price: Decimal
    filled_qty: Decimal = 0
    status: str = "NEW"  # "NEW", "PARTIALLY_FILLED", "FILLED", "CANCELLED"
    reduce_only: bool = False
    created_at: datetime
    updated_at: datetime
```

## Тесты

Все тесты находятся в [tests/test_exe002_position_state.py](../tests/test_exe002_position_state.py)

**Группы тестов:**
- `TestPositionStateManager` - базовые операции
- `TestPartialFills` - обработка partial fills
- `TestReduceOnly` - защита от переворота, reduceOnly
- `TestReconciliation` - reconciliation с биржей
- `TestShortPosition` - short позиции
- `TestOrderTracking` - отслеживание ордеров
- `TestGetInfo` - получение информации

**Запуск:**
```bash
pytest tests/test_exe002_position_state.py -v
# 17 passed
```

## Использование

### Пример: Трейдинг с partial fills

```python
from decimal import Decimal
from execution.position_state_manager import PositionStateManager

# Создаем менеджер
manager = PositionStateManager("ETHUSDT")

# Открываем long позицию
manager.open_position("Long", Decimal("10"), Decimal("3000"), "order_1")
print(f"Opened: {manager.position.qty} ETH @ {manager.position.avg_entry_price}")

# Получаем partial fill - цена выше
manager.add_partial_fill("order_2", Decimal("5"), Decimal("3100"), "Long")
print(f"Avg price: {manager.position.avg_entry_price}")

# Еще partial fill - цена ниже
manager.add_partial_fill("order_3", Decimal("5"), Decimal("2900"), "Long")
print(f"Avg price: {manager.position.avg_entry_price}")

# Закрываем половину
manager.close_position(Decimal("10"), Decimal("3200"), "order_4")
print(f"Position remaining: {manager.position.qty}")

# Reconcile с биржей
manager.reconcile_with_exchange(Decimal("10"), Decimal("3000"))

# Получаем информацию
info = manager.get_position_info()
print(f"Position: {info}")
```

## Интеграция

PositionStateManager предназначена для использования в:

1. **OrderManager** - для отслеживания состояния каждой позиции
2. **TradingBot** - для управления открытыми позициями
3. **Strategy** - для получения информации о текущем состоянии

### Использование в OrderManager

```python
class OrderManager:
    def __init__(self):
        self.positions = {}  # symbol -> PositionStateManager
    
    def submit_order(self, symbol: str, side: str, qty: Decimal, price: Decimal):
        if symbol not in self.positions:
            self.positions[symbol] = PositionStateManager(symbol)
        
        manager = self.positions[symbol]
        # ... открыть позицию ...
    
    def process_fill(self, symbol: str, order_id: str, fill_qty: Decimal, fill_price: Decimal, side: str):
        manager = self.positions[symbol]
        manager.add_partial_fill(order_id, fill_qty, fill_price, side)
```

## DoD (Definition of Done)

✅ Все гарантии работают корректно  
✅ 17 unit тестов pass  
✅ Partial fills обновляют avg_price по формуле  
✅ Position flip protection  
✅ reduceOnly enforcement  
✅ Reconciliation синхронизирует с биржей  

## Следующие этапы (EXE-003, EXE-004)

- **EXE-003**: Slippage и spread accounting
- **EXE-004**: Advanced order management (stops, limits)
