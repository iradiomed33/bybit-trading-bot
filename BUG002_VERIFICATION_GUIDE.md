# Как проверить исправление BUG-002

## Быстрая проверка

### 1. Запустить демонстрацию
```bash
python demo_bug002_fix.py
```

**Ожидаемый результат:**
- ✅ Показывает что старое поведение блокировало торговлю
- ✅ Показывает что новое поведение разрешает торговлю на нормальных свечах
- ✅ Показывает что реальные аномалии детектируются корректно

### 2. Запустить тесты
```bash
# Все тесты на аномалии
python -m pytest tests/test_anomaly_detection.py -v

# Интеграционные тесты
python -m pytest tests/test_meta_layer_symbol_fix.py -v
```

**Ожидаемый результат:**
- ✅ 15/15 тестов проходят

## Проверка в реальной торговле

### До исправления (проблема)
В логах часто появляется:
```
REJECTED | Strategy=MetaLayer | Symbol=BTCUSDT | Direction=N/A | 
Reasons=["no_trade_zone"] | Values={"reason":"Data anomaly detected", "anomaly_wick": 1}
```

Даже на нормальном рынке, когда:
- Текущая свеча формируется (open ≈ close)
- Цена совершает нормальные движения, создавая тени

### После исправления (решение)
Блокировки "Data anomaly detected" становятся редкими и происходят только когда:
- Последняя **закрытая** свеча имеет экстремальную тень (> 2% от цены И > 3x тела)
- Или другие реальные аномалии (gap, low volume) на закрытой свече

## Понимание логики

### Ключевое изменение
```python
# СТАРОЕ (проблема):
latest = df.iloc[-1]  # ← формирующаяся свеча, малое тело → ложные срабатывания

# НОВОЕ (решение):
if len(df) < 2:
    candle_for_quality_check = df.iloc[-1]  # Fallback для одной свечи
else:
    candle_for_quality_check = df.iloc[-2]  # ← закрытая свеча, стабильное тело
```

### Почему это важно
Формирующаяся свеча (текущая) имеет:
- `body = abs(close - open)` может быть ~0 (doji)
- Даже обычные тени становятся "> 3 * body"
- Результат: ложное срабатывание

Закрытая свеча:
- `body` уже сформировано и стабильно
- Тени оцениваются относительно реального тела
- Результат: точная детекция аномалий

## Мониторинг после деплоя

### Что наблюдать
1. **Частота блокировок** "Data anomaly detected" должна снизиться
2. **Детали в логах** теперь показывают конкретный тип аномалии
3. **Сигналы** должны генерироваться чаще (меньше ложных блокировок)

### Примеры правильного поведения

**Ситуация 1: Формирующаяся свеча с doji**
- Текущая свеча: open=100, close=100, high=102 (тень 2%)
- Последняя закрытая: нормальная свеча
- **Результат:** Торговля разрешена ✅

**Ситуация 2: Реальная аномалия на закрытой свече**
- Текущая свеча: нормальная
- Последняя закрытая: экстремальная тень 20%
- **Результат:** Торговля заблокирована ✅
- **Лог:** `"anomaly_wick": 1` в деталях

**Ситуация 3: Единственная свеча**
- DataFrame содержит только 1 свечу
- **Результат:** Используется эта свеча (fallback) ✅

## Откат изменений (если потребуется)

Если по каким-то причинам нужно откатить изменения:

```bash
git revert ba886ff  # Откатить этот коммит
```

Но это **не рекомендуется**, т.к. исправление:
- Прошло 15/15 тестов
- Прошло code review
- Прошло security check
- Демонстрация показывает корректную работу

## Поддержка

При возникновении вопросов см.:
- `BUG002_FIX_SUMMARY.md` - полное описание исправления
- `demo_bug002_fix.py` - демонстрация работы
- `tests/test_anomaly_detection.py` - тесты
