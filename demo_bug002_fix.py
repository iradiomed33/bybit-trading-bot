"""
–î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è BUG-002: –ê–Ω–æ–º–∞–ª–∏–∏ –Ω–∞ —Ñ–æ—Ä–º–∏—Ä—É—é—â–µ–π—Å—è —Å–≤–µ—á–µ

–≠—Ç–æ—Ç —Å–∫—Ä–∏–ø—Ç –¥–µ–º–æ–Ω—Å—Ç—Ä–∏—Ä—É–µ—Ç:
1. –°–¢–ê–†–û–ï –ø–æ–≤–µ–¥–µ–Ω–∏–µ: –∞–Ω–æ–º–∞–ª–∏—è –Ω–∞ —Ñ–æ—Ä–º–∏—Ä—É—é—â–µ–π—Å—è —Å–≤–µ—á–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç —Ç–æ—Ä–≥–æ–≤–ª—é (–æ—à–∏–±–∫–∞)
2. –ù–û–í–û–ï –ø–æ–≤–µ–¥–µ–Ω–∏–µ: –∞–Ω–æ–º–∞–ª–∏—è –Ω–∞ —Ñ–æ—Ä–º–∏—Ä—É—é—â–µ–π—Å—è —Å–≤–µ—á–µ –∏–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç—Å—è (–ø—Ä–∞–≤–∏–ª—å–Ω–æ)

–†–µ–∑—É–ª—å—Ç–∞—Ç: —É–º–µ–Ω—å—à–µ–Ω–∏–µ –ª–æ–∂–Ω—ã—Ö —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏–π "Data anomaly detected"
"""

import pandas as pd
import numpy as np
from data.features import FeaturePipeline
from strategy.meta_layer import NoTradeZones

def create_test_scenario():
    """
    –°–æ–∑–¥–∞–µ–º —Å—Ü–µ–Ω–∞—Ä–∏–π –≥–¥–µ:
    - –ü–æ—Å–ª–µ–¥–Ω—è—è –ó–ê–ö–†–´–¢–ê–Ø —Å–≤–µ—á–∞ (iloc[-2]) - –Ω–æ—Ä–º–∞–ª—å–Ω–∞—è
    - –¢–µ–∫—É—â–∞—è –§–û–†–ú–ò–†–£–Æ–©–ê–Ø–°–Ø —Å–≤–µ—á–∞ (iloc[-1]) - —Å –∞–Ω–æ–º–∞–ª–∏–µ–π (doji + —Ç–µ–Ω–∏)
    
    –≠—Ç–æ —Ç–∏–ø–∏—á–Ω–∞—è —Å–∏—Ç—É–∞—Ü–∏—è –∫–æ–≥–¥–∞ —Ç–µ–∫—É—â–∞—è —Å–≤–µ—á–∞ –µ—â–µ —Ñ–æ—Ä–º–∏—Ä—É–µ—Ç—Å—è –∏ –∏–º–µ–µ—Ç
    –º–∞–ª–æ–µ —Ç–µ–ª–æ, –Ω–æ –Ω–æ—Ä–º–∞–ª—å–Ω—ã–µ –¥–≤–∏–∂–µ–Ω–∏—è —Ü–µ–Ω—ã —Å–æ–∑–¥–∞—é—Ç —Ç–µ–Ω–∏ > 2% –æ—Ç —Ü–µ–Ω—ã.
    """
    data = pd.DataFrame({
        # –ü—Ä–µ–¥—ã–¥—É—â–∏–µ –Ω–æ—Ä–º–∞–ª—å–Ω—ã–µ —Å–≤–µ—á–∏
        "open": [100.0, 101.0, 102.0],
        "high": [101.0, 102.0, 103.0],
        "low": [99.0, 100.0, 101.0],
        "close": [100.5, 101.5, 102.5],
        "volume": [1000, 1000, 1000]
    })
    
    # –î–æ–±–∞–≤–ª—è–µ–º —Ç–µ–∫—É—â—É—é —Ñ–æ—Ä–º–∏—Ä—É—é—â—É—é—Å—è —Å–≤–µ—á—É —Å –∞–Ω–æ–º–∞–ª–∏–µ–π (doji + —Ç–µ–Ω—å)
    current_forming_candle = pd.DataFrame({
        "open": [102.5],      # –û—Ç–∫—Ä—ã–ª–∞—Å—å –Ω–∞ 102.5
        "high": [105.0],      # –ü–æ—à–ª–∞ –≤–≤–µ—Ä—Ö –Ω–∞ 2.5 (—Ç–µ–Ω—å ~2.4%)
        "low": [102.0],       # –û—Ç–∫–∞—Ç –≤–Ω–∏–∑
        "close": [102.5],     # –¢–µ–∫—É—â–∞—è —Ü–µ–Ω–∞ = open (doji)
        "volume": [1000]
    })
    
    return pd.concat([data, current_forming_candle], ignore_index=True)

def simulate_old_behavior(df_with_anomalies):
    """
    –°–∏–º—É–ª–∏—Ä—É–µ—Ç –°–¢–ê–†–û–ï –ø–æ–≤–µ–¥–µ–Ω–∏–µ: –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ—Å–ª–µ–¥–Ω–µ–π —Å–≤–µ—á–∏ (iloc[-1])
    """
    latest = df_with_anomalies.iloc[-1]
    has_anomaly = latest.get("has_anomaly", 0)
    
    if has_anomaly == 1:
        anomaly_details = {}
        if latest.get("anomaly_wick", 0) == 1:
            anomaly_details["anomaly_wick"] = 1
        if latest.get("anomaly_low_volume", 0) == 1:
            anomaly_details["anomaly_low_volume"] = 1
        if latest.get("anomaly_gap", 0) == 1:
            anomaly_details["anomaly_gap"] = 1
        
        return False, "Data anomaly detected", anomaly_details
    
    return True, None, None

def main():
    print("=" * 80)
    print("–î–ï–ú–û–ù–°–¢–†–ê–¶–ò–Ø –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø BUG-002")
    print("=" * 80)
    print()
    
    # –°–æ–∑–¥–∞–µ–º —Ç–µ—Å—Ç–æ–≤—ã–π —Å—Ü–µ–Ω–∞—Ä–∏–π
    raw_data = create_test_scenario()
    print("üìä –¢–µ—Å—Ç–æ–≤—ã–π —Å—Ü–µ–Ω–∞—Ä–∏–π:")
    print("   - 3 –Ω–æ—Ä–º–∞–ª—å–Ω—ã—Ö –∑–∞–∫—Ä—ã—Ç—ã—Ö —Å–≤–µ—á–∏")
    print("   - 1 —Ñ–æ—Ä–º–∏—Ä—É—é—â–∞—è—Å—è —Å–≤–µ—á–∞ —Å doji –∏ —Ç–µ–Ω—å—é ~2.4%")
    print()
    
    # –ü—Ä–∏–º–µ–Ω—è–µ–º feature pipeline
    pipeline = FeaturePipeline()
    df_with_anomalies = pipeline.detect_data_anomalies(raw_data)
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–Ω–æ–º–∞–ª–∏–∏
    print("üîç –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –¥–µ—Ç–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∞–Ω–æ–º–∞–ª–∏–π:")
    print(f"   –ü–æ—Å–ª–µ–¥–Ω—è—è –∑–∞–∫—Ä—ã—Ç–∞—è —Å–≤–µ—á–∞ (iloc[-2]):")
    print(f"     - has_anomaly: {df_with_anomalies.iloc[-2]['has_anomaly']}")
    print(f"     - anomaly_wick: {df_with_anomalies.iloc[-2]['anomaly_wick']}")
    print()
    print(f"   –§–æ—Ä–º–∏—Ä—É—é—â–∞—è—Å—è —Å–≤–µ—á–∞ (iloc[-1]):")
    print(f"     - has_anomaly: {df_with_anomalies.iloc[-1]['has_anomaly']}")
    print(f"     - anomaly_wick: {df_with_anomalies.iloc[-1]['anomaly_wick']}")
    print()
    
    # –°—Ç–∞—Ä–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ
    print("‚ùå –°–¢–ê–†–û–ï –ü–û–í–ï–î–ï–ù–ò–ï (–¥–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è):")
    old_allowed, old_reason, old_details = simulate_old_behavior(df_with_anomalies)
    print(f"   –ü—Ä–æ–≤–µ—Ä—è–µ—Ç: –ø–æ—Å–ª–µ–¥–Ω—é—é —Å–≤–µ—á—É (iloc[-1]) - —Ñ–æ—Ä–º–∏—Ä—É—é—â—É—é—Å—è")
    print(f"   –¢–æ—Ä–≥–æ–≤–ª—è —Ä–∞–∑—Ä–µ—à–µ–Ω–∞: {old_allowed}")
    if not old_allowed:
        print(f"   –ü—Ä–∏—á–∏–Ω–∞ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏: {old_reason}")
        print(f"   –î–µ—Ç–∞–ª–∏: {old_details}")
    print(f"   ‚ö†Ô∏è  –ü–†–û–ë–õ–ï–ú–ê: –ë–ª–æ–∫–∏—Ä—É–µ—Ç —Ç–æ—Ä–≥–æ–≤–ª—é –∏–∑-–∑–∞ –Ω–æ—Ä–º–∞–ª—å–Ω–æ–π —Ñ–æ—Ä–º–∏—Ä—É—é—â–µ–π—Å—è —Å–≤–µ—á–∏!")
    print()
    
    # –ù–æ–≤–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ
    print("‚úÖ –ù–û–í–û–ï –ü–û–í–ï–î–ï–ù–ò–ï (–ø–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è):")
    features = {"symbol": "BTCUSDT"}
    new_allowed, new_reason, new_details = NoTradeZones.is_trading_allowed(
        df_with_anomalies, features, error_count=0
    )
    print(f"   –ü—Ä–æ–≤–µ—Ä—è–µ—Ç: –ø—Ä–µ–¥–ø–æ—Å–ª–µ–¥–Ω—é—é —Å–≤–µ—á—É (iloc[-2]) - –∑–∞–∫—Ä—ã—Ç—É—é")
    print(f"   –¢–æ—Ä–≥–æ–≤–ª—è —Ä–∞–∑—Ä–µ—à–µ–Ω–∞: {new_allowed}")
    if not new_allowed:
        print(f"   –ü—Ä–∏—á–∏–Ω–∞ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏: {new_reason}")
        print(f"   –î–µ—Ç–∞–ª–∏: {new_details}")
    else:
        print(f"   ‚úì –¢–æ—Ä–≥–æ–≤–ª—è —Ä–∞–∑—Ä–µ—à–µ–Ω–∞ - —Ñ–æ—Ä–º–∏—Ä—É—é—â–∞—è—Å—è —Å–≤–µ—á–∞ –∏–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç—Å—è!")
    print()
    
    # –°—Ä–∞–≤–Ω–µ–Ω–∏–µ
    print("=" * 80)
    print("üìà –ò–¢–û–ì:")
    print("=" * 80)
    if old_allowed != new_allowed:
        print("‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç!")
        print("   - –°–¢–ê–†–û–ï: –±–ª–æ–∫–∏—Ä–æ–≤–∞–ª–æ —Ç–æ—Ä–≥–æ–≤–ª—é (–ª–æ–∂–Ω–æ–µ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏–µ)")
        print("   - –ù–û–í–û–ï: —Ä–∞–∑—Ä–µ—à–∞–µ—Ç —Ç–æ—Ä–≥–æ–≤–ª—é (–ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ)")
        print()
        print("üí° –†–µ–∑—É–ª—å—Ç–∞—Ç: –º–µ–Ω—å—à–µ –ª–æ–∂–Ω—ã—Ö –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫ 'Data anomaly detected'")
    else:
        print("‚ÑπÔ∏è  –í —ç—Ç–æ–º —Å—Ü–µ–Ω–∞—Ä–∏–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –æ–¥–∏–Ω–∞–∫–æ–≤—ã–µ")
    print()
    
    # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π —Ç–µ—Å—Ç: —Ä–µ–∞–ª—å–Ω–∞—è –∞–Ω–æ–º–∞–ª–∏—è –Ω–∞ –∑–∞–∫—Ä—ã—Ç–æ–π —Å–≤–µ—á–µ
    print("=" * 80)
    print("üß™ –î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–´–ô –¢–ï–°–¢: –†–µ–∞–ª—å–Ω–∞—è –∞–Ω–æ–º–∞–ª–∏—è –Ω–∞ –∑–∞–∫—Ä—ã—Ç–æ–π —Å–≤–µ—á–µ")
    print("=" * 80)
    print()
    
    data_with_real_anomaly = pd.DataFrame({
        "open": [100.0, 101.0, 102.0],
        "high": [101.0, 102.0, 125.0],  # –≠–∫—Å—Ç—Ä–µ–º–∞–ª—å–Ω–∞—è —Ç–µ–Ω—å –Ω–∞ –∑–∞–∫—Ä—ã—Ç–æ–π —Å–≤–µ—á–µ
        "low": [99.0, 100.0, 101.0],
        "close": [100.5, 101.5, 102.2],  # –ú–∞–ª–æ–µ —Ç–µ–ª–æ –Ω–∞ –∑–∞–∫—Ä—ã—Ç–æ–π
        "volume": [1000, 1000, 1000]
    })
    
    # –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ—Ä–º–∞–ª—å–Ω—É—é —Ñ–æ—Ä–º–∏—Ä—É—é—â—É—é—Å—è —Å–≤–µ—á—É
    current_normal = pd.DataFrame({
        "open": [102.2],
        "high": [103.0],
        "low": [102.0],
        "close": [102.5],
        "volume": [1000]
    })
    
    data_with_real_anomaly = pd.concat([data_with_real_anomaly, current_normal], ignore_index=True)
    df_real_anomaly = pipeline.detect_data_anomalies(data_with_real_anomaly)
    
    real_allowed, real_reason, real_details = NoTradeZones.is_trading_allowed(
        df_real_anomaly, features, error_count=0
    )
    
    print("üìä –°—Ü–µ–Ω–∞—Ä–∏–π: –≠–∫—Å—Ç—Ä–µ–º–∞–ª—å–Ω–∞—è —Ç–µ–Ω—å –Ω–∞ –ø–æ—Å–ª–µ–¥–Ω–µ–π –ó–ê–ö–†–´–¢–û–ô —Å–≤–µ—á–µ")
    print(f"   –¢–æ—Ä–≥–æ–≤–ª—è —Ä–∞–∑—Ä–µ—à–µ–Ω–∞: {real_allowed}")
    if not real_allowed:
        print(f"   –ü—Ä–∏—á–∏–Ω–∞ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏: {real_reason}")
        print(f"   –î–µ—Ç–∞–ª–∏: {real_details}")
        print(f"   ‚úì –ü—Ä–∞–≤–∏–ª—å–Ω–æ! –†–µ–∞–ª—å–Ω–∞—è –∞–Ω–æ–º–∞–ª–∏—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –¥–µ—Ç–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∞")
    print()
    
    print("=" * 80)
    print("‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï BUG-002 –†–ê–ë–û–¢–ê–ï–¢ –ö–û–†–†–ï–ö–¢–ù–û")
    print("=" * 80)

if __name__ == "__main__":
    main()
