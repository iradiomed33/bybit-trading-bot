"""
–î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è BUG-005: POST signature mismatch

–≠—Ç–æ—Ç —Å–∫—Ä–∏–ø—Ç –¥–µ–º–æ–Ω—Å—Ç—Ä–∏—Ä—É–µ—Ç:
1. –°–¢–ê–†–û–ï –ø–æ–≤–µ–¥–µ–Ω–∏–µ: body –ø–æ–¥–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è –æ–¥–Ω–∞, –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –¥—Ä—É–≥–∞—è ‚Üí invalid signature
2. –ù–û–í–û–ï –ø–æ–≤–µ–¥–µ–Ω–∏–µ: –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è —Ç–æ—á–Ω–æ —Ç–∞ –∂–µ —Å—Ç—Ä–æ–∫–∞ —á—Ç–æ –ø–æ–¥–ø–∏—Å–∞–Ω–∞

–†–µ–∑—É–ª—å—Ç–∞—Ç: –ø—Ä–∏–≤–∞—Ç–Ω—ã–µ POST-–∑–∞–ø—Ä–æ—Å—ã —Ä–∞–±–æ—Ç–∞—é—Ç —Å—Ç–∞–±–∏–ª—å–Ω–æ –±–µ–∑ signature errors
"""

import json
from urllib.parse import urlencode


def demo_old_behavior():
    """
    –î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è –°–¢–ê–†–û–ì–û –ø–æ–≤–µ–¥–µ–Ω–∏—è (–¥–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è):
    - body_string –ø–æ–¥–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è —Å separators=(",", ":")
    - –ù–æ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è json=params (—Å –ø—Ä–æ–±–µ–ª–∞–º–∏)
    - –ü–æ–¥–ø–∏—Å—å –Ω–µ —Å–æ–≤–ø–∞–¥–∞–µ—Ç ‚Üí invalid signature
    """
    print("=" * 80)
    print("‚ùå –°–¢–ê–†–û–ï –ü–û–í–ï–î–ï–ù–ò–ï (–¥–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è BUG-005)")
    print("=" * 80)
    print()
    print("–ü—Ä–æ–±–ª–µ–º–∞: POST body –Ω–µ —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å –ø–æ–¥–ø–∏—Å–∞–Ω–Ω–æ–π —Å—Ç—Ä–æ–∫–æ–π")
    print()
    
    params = {
        "symbol": "BTCUSDT",
        "side": "Buy",
        "orderType": "Limit",
        "qty": "0.001",
        "price": "50000"
    }
    
    # –ß—Ç–æ –ø–æ–¥–ø–∏—Å—ã–≤–∞–ª–æ—Å—å
    signed_body = json.dumps(params, separators=(",", ":"))
    print("1. –°—Ç—Ä–æ–∫–∞ –¥–ª—è –ø–æ–¥–ø–∏—Å–∏ (separators=(',', ':')):")
    print(f"   {signed_body}")
    print()
    
    # –ß—Ç–æ –æ—Ç–ø—Ä–∞–≤–ª—è–ª–æ—Å—å (json=params)
    # requests –∏—Å–ø–æ–ª—å–∑—É–µ—Ç json.dumps() —Å –¥–µ—Ñ–æ–ª—Ç–Ω—ã–º–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏
    sent_body = json.dumps(params)  # –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –¥–æ–±–∞–≤–ª—è–µ—Ç –ø—Ä–æ–±–µ–ª—ã
    print("2. –ß—Ç–æ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç requests.post(url, json=params):")
    print(f"   {sent_body}")
    print()
    
    # –°—Ä–∞–≤–Ω–µ–Ω–∏–µ
    print("3. –°—Ä–∞–≤–Ω–µ–Ω–∏–µ:")
    print(f"   –ü–æ–¥–ø–∏—Å–∞–Ω–æ:  '{signed_body}'")
    print(f"   –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ: '{sent_body}'")
    print()
    
    if signed_body == sent_body:
        print("   ‚úì –°—Ç—Ä–æ–∫–∏ —Å–æ–≤–ø–∞–¥–∞—é—Ç")
    else:
        print("   ‚úó –°–¢–†–û–ö–ò –ù–ï –°–û–í–ü–ê–î–ê–Æ–¢!")
        print()
        print("–†–µ–∑—É–ª—å—Ç–∞—Ç:")
        print("  ‚úó HMAC signature —Å—á–∏—Ç–∞–µ—Ç—Å—è –æ—Ç –æ–¥–Ω–æ–π —Å—Ç—Ä–æ–∫–∏")
        print("  ‚úó –ù–æ —Å–µ—Ä–≤–µ—Ä –ø–æ–ª—É—á–∞–µ—Ç –î–†–£–ì–£–Æ —Å—Ç—Ä–æ–∫—É")
        print("  ‚úó –°–µ—Ä–≤–µ—Ä –≤—ã—á–∏—Å–ª—è–µ—Ç signature –æ—Ç –ø–æ–ª—É—á–µ–Ω–Ω–æ–π —Å—Ç—Ä–æ–∫–∏")
        print("  ‚úó –ü–æ–¥–ø–∏—Å–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç ‚Üí 'invalid signature' error")
    print()


def demo_new_behavior():
    """
    –î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è –ù–û–í–û–ì–û –ø–æ–≤–µ–¥–µ–Ω–∏—è (–ø–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è):
    - body_string —Å–æ–∑–¥–∞–µ—Ç—Å—è —Å separators=(",", ":")
    - –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è data=body_string.encode("utf-8")
    - –¢–æ—á–Ω–æ —Ç–∞ –∂–µ —Å—Ç—Ä–æ–∫–∞ ‚Üí –ø–æ–¥–ø–∏—Å—å —Å–æ–≤–ø–∞–¥–∞–µ—Ç
    """
    print("=" * 80)
    print("‚úÖ –ù–û–í–û–ï –ü–û–í–ï–î–ï–ù–ò–ï (–ø–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è BUG-005)")
    print("=" * 80)
    print()
    print("–†–µ—à–µ–Ω–∏–µ: –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å —Ç–æ—á–Ω–æ —Ç—É –∂–µ —Å—Ç—Ä–æ–∫—É —á—Ç–æ –ø–æ–¥–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è")
    print()
    
    params = {
        "symbol": "BTCUSDT",
        "side": "Buy",
        "orderType": "Limit",
        "qty": "0.001",
        "price": "50000"
    }
    
    # –ß—Ç–æ –ø–æ–¥–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è
    body_string = json.dumps(params, separators=(",", ":"))
    print("1. –°—Ç—Ä–æ–∫–∞ –¥–ª—è –ø–æ–¥–ø–∏—Å–∏:")
    print(f"   {body_string}")
    print()
    
    # –ß—Ç–æ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è (—Ç–µ–ø–µ—Ä—å –∏—Å–ø–æ–ª—å–∑—É–µ–º data=body_string.encode())
    print("2. –ß—Ç–æ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è —Å data=body_string.encode('utf-8'):")
    print(f"   {body_string}")
    print()
    
    # –°—Ä–∞–≤–Ω–µ–Ω–∏–µ
    print("3. –°—Ä–∞–≤–Ω–µ–Ω–∏–µ:")
    print(f"   –ü–æ–¥–ø–∏—Å–∞–Ω–æ:  '{body_string}'")
    print(f"   –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ: '{body_string}'")
    print()
    print("   ‚úì –°—Ç—Ä–æ–∫–∏ –ò–î–ï–ù–¢–ò–ß–ù–´!")
    print()
    print("–†–µ–∑—É–ª—å—Ç–∞—Ç:")
    print("  ‚úì HMAC signature —Å—á–∏—Ç–∞–µ—Ç—Å—è –æ—Ç body_string")
    print("  ‚úì –°–µ—Ä–≤–µ—Ä –ø–æ–ª—É—á–∞–µ—Ç –¢–£ –ñ–ï body_string")
    print("  ‚úì –°–µ—Ä–≤–µ—Ä –≤—ã—á–∏—Å–ª—è–µ—Ç —Ç–∞–∫—É—é –∂–µ signature")
    print("  ‚úì –ü–æ–¥–ø–∏—Å–∏ —Å–æ–≤–ø–∞–¥–∞—é—Ç ‚Üí –∑–∞–ø—Ä–æ—Å –ø—Ä–∏–Ω—è—Ç!")
    print()
    print("–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ:")
    print("  ‚úì –î–æ–±–∞–≤–ª–µ–Ω header Content-Type: application/json")
    print("  ‚úì –î–ª—è unsigned POST –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å json=params")
    print()


def demo_get_query_encoding():
    """
    –î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è query_string –¥–ª—è GET
    """
    print("=" * 80)
    print("üîß –î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: GET query_string")
    print("=" * 80)
    print()
    
    params = {
        "symbol": "BTC/USDT",  # –°–æ–¥–µ—Ä–∂–∏—Ç —Å–ø–µ—Ü—Å–∏–º–≤–æ–ª /
        "category": "linear",
        "test": "a b"  # –°–æ–¥–µ—Ä–∂–∏—Ç –ø—Ä–æ–±–µ–ª
    }
    
    # –°—Ç–∞—Ä—ã–π —Å–ø–æ—Å–æ–± (—Ä—É—á–Ω–æ–µ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ)
    old_query = "&".join(f"{k}={v}" for k, v in sorted(params.items()))
    print("‚ùå –°–¢–ê–†–´–ô —Å–ø–æ—Å–æ–± (—Ä—É—á–Ω–æ–µ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ):")
    print(f"   query_string = '&'.join(f'{{k}}={{v}}' for k, v in sorted(params.items()))")
    print(f"   –†–µ–∑—É–ª—å—Ç–∞—Ç: {old_query}")
    print()
    print("   –ü—Ä–æ–±–ª–µ–º–∞: —Å–ø–µ—Ü—Å–∏–º–≤–æ–ª—ã –ù–ï —ç–∫—Ä–∞–Ω–∏—Ä—É—é—Ç—Å—è!")
    print("   - –°–ª—ç—à '/' –æ—Å—Ç–∞–µ—Ç—Å—è –∫–∞–∫ –µ—Å—Ç—å")
    print("   - –ü—Ä–æ–±–µ–ª ' ' –æ—Å—Ç–∞–µ—Ç—Å—è –∫–∞–∫ –µ—Å—Ç—å")
    print()
    
    # –ù–æ–≤—ã–π —Å–ø–æ—Å–æ–± (urlencode)
    new_query = urlencode(sorted(params.items()))
    print("‚úÖ –ù–û–í–´–ô —Å–ø–æ—Å–æ–± (urlencode):")
    print(f"   query_string = urlencode(sorted(params.items()))")
    print(f"   –†–µ–∑—É–ª—å—Ç–∞—Ç: {new_query}")
    print()
    print("   ‚úì –°–ø–µ—Ü—Å–∏–º–≤–æ–ª—ã –ø—Ä–∞–≤–∏–ª—å–Ω–æ —ç–∫—Ä–∞–Ω–∏—Ä—É—é—Ç—Å—è!")
    print("   - –°–ª—ç—à '/' ‚Üí '%2F'")
    print("   - –ü—Ä–æ–±–µ–ª ' ' ‚Üí '+'")
    print()
    print("   ‚úì –ü–æ–¥–ø–∏—Å—å –∏ —Ä–µ–∞–ª—å–Ω—ã–π –∑–∞–ø—Ä–æ—Å –∏—Å–ø–æ–ª—å–∑—É—é—Ç –æ–¥–∏–Ω–∞–∫–æ–≤–æ–µ —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ")
    print()


def main():
    print()
    print("=" * 80)
    print("–î–ï–ú–û–ù–°–¢–†–ê–¶–ò–Ø –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø BUG-005")
    print("POST signature mismatch")
    print("=" * 80)
    print()
    
    # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç–∞—Ä–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ
    demo_old_behavior()
    
    # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω–æ–≤–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ
    demo_new_behavior()
    
    # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º GET query encoding
    demo_get_query_encoding()
    
    # –ò—Ç–æ–≥
    print("=" * 80)
    print("üìà –ò–¢–û–ì")
    print("=" * 80)
    print()
    print("‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç!")
    print()
    print("–ß—Ç–æ –±—ã–ª–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ:")
    print("  1. –î–æ–±–∞–≤–ª–µ–Ω import urlencode –∏–∑ urllib.parse")
    print("  2. –î–ª—è signed POST:")
    print("     - –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è data=body_string.encode('utf-8')")
    print("     - –í–º–µ—Å—Ç–æ json=params")
    print("     - –î–æ–±–∞–≤–ª–µ–Ω Content-Type: application/json")
    print("  3. –î–ª—è signed GET:")
    print("     - query_string —Ñ–æ—Ä–º–∏—Ä—É–µ—Ç—Å—è —á–µ—Ä–µ–∑ urlencode()")
    print("     - –ü—Ä–∞–≤–∏–ª—å–Ω–æ–µ —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–ø–µ—Ü—Å–∏–º–≤–æ–ª–æ–≤")
    print()
    print("–†–µ–∑—É–ª—å—Ç–∞—Ç:")
    print("  ‚Ä¢ –ü–æ–¥–ø–∏—Å–∞–Ω–Ω–∞—è —Å—Ç—Ä–æ–∫–∞ –¢–û–ß–ù–û —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω–æ–π")
    print("  ‚Ä¢ –ù–µ—Ç –æ—à–∏–±–æ–∫ 'invalid signature'")
    print("  ‚Ä¢ –ü—Ä–∏–≤–∞—Ç–Ω—ã–µ POST-–∑–∞–ø—Ä–æ—Å—ã —Ä–∞–±–æ—Ç–∞—é—Ç —Å—Ç–∞–±–∏–ª—å–Ω–æ")
    print("  ‚Ä¢ –ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ GET –∑–∞–ø—Ä–æ—Å–∞—Ö")
    print()
    print("–ö—Ä–∏—Ç–µ—Ä–∏–∏ –ø—Ä–∏—ë–º–∫–∏:")
    print("  ‚úÖ –õ—é–±–æ–π –ø—Ä–∏–≤–∞—Ç–Ω—ã–π POST —Å—Ç–∞–±–∏–ª—å–Ω–æ –ø—Ä–æ—Ö–æ–¥–∏—Ç –±–µ–∑ signature errors")
    print()
    print("=" * 80)
    print("‚úÖ BUG-005 –ò–°–ü–†–ê–í–õ–ï–ù")
    print("=" * 80)
    print()


if __name__ == "__main__":
    main()
